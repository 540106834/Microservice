好，我们来做一次“数据穿越之旅”🎫。
从学生刷卡那一瞬间开始，一条考勤记录将像一枚小小信使，穿过网络长廊，经过网关关卡，最终落入数据库的档案柜。

我给你演示一条**完整、真实、工程级的处理流程**。

不讲虚的，直接上“可运行脑补版”。

---

# ⭐ 场景设定

某学生早上进校：

```
设备ID: 860123456789012
卡号:   00004567
时间:   20260201075930
类型:   0 (进校)
SN:     0001
功能号: 09 (F09上传)
```

---

# ⭐ 第一步：设备拼包

设备按协议构造字符串：

## ✅ 包内容：

```
860123456789012
01
00004567
20260201075930
0
```

拼接后：

```
8601234567890120100004567202602010759300
```

假设长度 = 39

---

## ✅ 包头：

```
引导码: DIRM01
包长度: 0051   (39 + 12)
功能号: 09
序列号: 0001
```

得到：

```
DIRM0100510900018601234567890120100004567202602010759300
```

---

## ✅ 校验和（示意）

假设算出：

```
AF
```

---

## ⭐ 最终完整报文：

```
DIRM0100510900018601234567890120100004567202602010759300AF
```

它被发射进TCP宇宙。

---

# ⭐ 第二步：到达 Netty 网关

此时网关像机场塔台一样接收信号。

---

## ✅ 1. FrameDecoder

先按：

> 包长度字段切包。

避免：

* 粘包
* 半包

这是第一道防线。

---

## ✅ 2. ProtocolDecoder

把字符串切割：

```java
deviceId = "860123456789012"
cardNum  = "01"
cardId   = "00004567"
time     = "20260201075930"
optType  = "0"
```

转成内部对象：

```java
AttendanceRecord
```

注意：

👉 此对象最好是**内部DTO**，不要直接当数据库实体。

这是高手习惯。

---

## ✅ 3. 校验和验证

如果失败：

直接丢弃 + 记录。

不要ACK。

设备会重发。

（协议已经帮你设计好容错机制）

---

# ⭐ 第三步：去重检查（非常关键🔥）

查询Redis：

```
key:
860123456789012_0001
```

* 存在 → 丢弃
* 不存在 → 写入TTL=10分钟

防止：

> 网络抖动导致重复打卡。

现实世界里极常见。

---

# ⭐ 第四步：极速入MQ

网关此刻只做一件事：

> 把数据扔进消息队列。

例如 Kafka：

```
topic:
attendance-record
```

为什么不直接写数据库？

因为你永远不知道：

> 下一秒会不会 5 万学生同时刷卡。

MQ是你的泄洪闸。

---

# ⭐ 第五步：立即ACK

构造响应：

```
valid_flag = 1
```

响应包发回设备。

整个过程建议：

> **小于 5ms**

越快越好。

否则设备会焦虑重发。

它们比你还“怕丢数据”。

---

# ⭐ 第六步：业务服务开始慢慢处理

现在节奏从“高速公路”变成“城市道路”。

消费者读取MQ：

---

## ✅ 写数据库

```sql
device_id
card_id
time
opt_type
```

---

## ✅ 判断是否迟到

例如：

```
> 08:00 → 迟到
```

---

## ✅ 触发通知（可选）

* 家长短信
* App推送

---

## ✅ 更新缓存状态

Redis：

```
student:last:in_time
```

用于：

* 实时看板
* 校园大屏

---

# ⭐ 整条链路总结（强烈建议记住）

```
设备
 ↓
Netty网关
 ↓
去重
 ↓
MQ
 ↓
业务服务
 ↓
数据库
```

一句口诀送你：

> **入口要快
> 中间要抗洪
> 后端可从容**

---

# ⭐ 一个90%新人不知道的优化点🔥

## 👉 批量写库！

不要：

```
1条 → insert
```

要：

```
100条 → batch insert
```

性能可能提升：

> **10倍以上**

早高峰时差别巨大。

---

# ⭐ 再告诉你一个“高手味道”的设计

建议存：

## 👉 原始报文 raw_packet

未来若出现：

> “家长说孩子明明刷了！”

你可以：

* 重放数据
* 排查设备
* 查校验

没有原始包的系统，排障如盲人摸钟。

---

# ⭐ 最后给你一个判断系统是否专业的小技巧

看ACK策略：

### ❌ 写完数据库再ACK

危险。

### ✅ 入MQ立即ACK

成熟。

---

如果你愿意，我还能带你看一个更刺激的东西：

👉 **10万学生在5分钟内同时刷卡会发生什么？**
👉 **网关会先死还是数据库先死？**
👉 **如何设计“永不崩”的考勤系统？**

直接说：

> 模拟高并发刷卡

我可以给你演一场“流量风暴”。
