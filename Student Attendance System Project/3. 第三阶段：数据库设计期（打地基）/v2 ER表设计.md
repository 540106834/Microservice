很好，这句话一旦刻进脑子里，你的数据库水平会出现明显分水岭。

> **ER图 = 数据世界的城市规划图**
> 建表只是“浇筑水泥”。

很多人顺序是错的：

```
❌ 先建表 → 再想关系 → 不断改表 → 数据迁移 → 痛苦
```

高手是：

```
✅ 先抽象世界 → 再落表
```

今天我带你画一张**接近真实生产的“考勤系统ER图”**，并告诉你每一步在想什么。

不用担心复杂，我会让结构非常“工程味”。

---

# ⭐ 第一步：识别“世界里有什么”

不要想表。

先想：

> 系统里到底有哪些“东西”？

考勤场景里最核心的只有5个：

### ✅ 学生（Student）

被考勤的人。

### ✅ 班级（Class）

学生属于某个班。

### ✅ 设备（Device）

谁在采集数据。

### ✅ 卡（Card）

身份媒介。

### ✅ 考勤记录（Attendance）

事件本身。

注意一个原则：

> **ER图画的是“现实对象”，不是技术对象。**

---

# ⭐ 第二步：找关系（这是灵魂🔥）

现在问：

> 谁依赖谁？

---

## ✅ 班级 ← 学生（1 : N）

```
一个班
   ↓
多个学生
```

现实不会反过来。

---

## ✅ 学生 ← 卡（1 : 1 或 1 : N）

取决于业务：

* 是否允许补卡？
* 是否允许临时卡？

### 强烈建议：

> 用 **1:N**

现实世界中：

* 卡会丢
* 会换卡

设计要拥抱混乱。

---

## ✅ 设备 ← 考勤记录（1 : N）

一台设备每天刷爆。

毫无疑问。

---

## ✅ 学生 ← 考勤记录（1 : N）

一个学生：

> 一生会留下数万条记录。

这是典型事件表。

---

# ⭐ 一张清晰ER图（文字版）

```
Class
  │ 1
  │
  └────< Student >────┐
          │ 1         │
          │           │
          ▼           ▼
        Card      Attendance >──── Device
                       ▲
                       │
                    (采集)
```

记住一个观察技巧：

> **Attendance 是“事实表”**
> 前面都是“维度表”。

这其实已经有点：

👉 数据仓库思维了。

非常高级。

---

# ⭐ 第三步：给实体“定属性”

只放核心字段。

不要一上来就塞20个。

---

## ✅ Student

建议：

```
student_id (PK)
name
class_id
status
created_at
```

不要存：

```
age ❌
```

年龄会变。

存：

```
birthday ✅
```

这是设计功力。

---

## ✅ Device

```
device_id (PK)
school_id
location
status
last_heartbeat
```

未来你会非常依赖：

> last_heartbeat

排障神器。

---

## ✅ Card

```
card_id (PK)
student_id
status
issued_at
```

建议加：

```
unique(card_id)
```

防止幽灵卡。

---

## ✅ Attendance（核心大表🔥）

这张表决定系统上限。

推荐结构：

```
id (PK)

student_id
device_id

card_id

attendance_time
opt_type

sn
raw_packet

created_at
```

看到没？

### ⭐ 我特地保留：

> raw_packet

未来排障时，它值黄金。

---

# ⭐ 一个90%新人会犯的错误 ⚠

## ❌ 在Attendance里存：

```
class_name
student_name
```

看似方便。

但：

学生改名怎么办？

全表更新。

灾难。

---

## 正确姿势：

查询时 JOIN
或者：

> 用缓存 / 搜索引擎做展示层。

数据库要稳。

---

# ⭐ 第四步：想“查询路径”（高手都会🔥）

问自己：

> 最常查什么？

考勤系统TOP3：

### ✅ 查某学生今天是否到校

👉 index(student_id, attendance_time)

---

### ✅ 查某班出勤率

👉 index(class_id)
（可通过student表）

---

### ✅ 查设备异常

👉 index(device_id)

---

> **索引不是性能优化。
> 而是设计的一部分。**

---

# ⭐ 再给你一个非常值钱的设计思想

## 👉 Attendance一定会爆炸增长。

提前想：

* 是否按月分表？
* 是否冷热分离？
* 是否归档？

否则几年后：

```
3亿 rows
```

任何查询都像拖着巨石走路。

---

# ⭐ 判断ER图是否合格的黄金标准

问自己三件事：

### ✅ 是否符合现实？

### ✅ 是否支持变化？

### ✅ 是否方便查询？

满足这三个：

> 基本就是好设计。

---

# ⭐ 最后送你一句架构圈常被引用的话：

> **“数据库不是为存储而设计。
> 是为查询而设计。”**

很多人反过来做。

于是系统越来越慢。

---

如果你愿意，我可以继续带你进阶一个非常刺激的层次：

👉 **我可以给你画一版“高并发考勤ER图”（支持百万学生）**
👉 **Attendance到底该不该分表？什么时候分？**
👉 **哪些字段必须加联合索引？**
👉 **如何避免未来痛苦迁移？**

直接说：

> 进阶ER图

我带你看一版“明显是架构师画的图”。
